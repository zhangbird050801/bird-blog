<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.birdy.mapper.ArticleMapper">

    <resultMap id="BaseResultMap" type="com.birdy.domain.entity.Article">
            <id property="id" column="id" />
            <result property="title" column="title" />
            <result property="slug" column="slug" />
            <result property="summary" column="summary" />
            <result property="content" column="content" />
            <result property="categoryId" column="category_id" />
            <result property="authorId" column="author_id" />
            <result property="thumbnail" column="thumbnail" />
            <result property="isTop" column="is_top" />
            <result property="status" column="status" />
            <result property="isComment" column="is_comment" />
            <result property="viewCount" column="view_count" />
            <result property="likeCount" column="like_count" />
            <result property="commentCount" column="comment_count" />
            <result property="publishedTime" column="published_time" />
            <result property="pinnedTime" column="pinned_time" />
            <result property="creator" column="creator" />
            <result property="createTime" column="create_time" />
            <result property="updater" column="updater" />
            <result property="updateTime" column="update_time" />
            <result property="deleted" column="deleted" />
    </resultMap>

    <sql id="Base_Column_List">
        id,title,slug,summary,content,category_id,
        author_id,thumbnail,is_top,status,is_comment,
        view_count,like_count,comment_count,published_time,pinned_time,
        creator,create_time,updater,update_time,deleted
    </sql>

    <!-- ArticleVO, 包含分类名称和标签信息 -->
    <resultMap id="ArticleVOResultMap" type="com.birdy.domain.vo.ArticleVO">
        <id property="id" column="id" />
        <result property="title" column="title" />
        <result property="slug" column="slug" />
        <result property="summary" column="summary" />
        <result property="categoryName" column="category_name" />
        <result property="thumbnail" column="thumbnail" />
        <result property="isTop" column="is_top" />
        <result property="viewCount" column="view_count" />
        <result property="likeCount" column="like_count" />
        <result property="publishedTime" column="published_time" />
        <result property="updateTime" column="update_time" />
    </resultMap>

    <!-- 分页查询文章列表 -->
    <select id="selectArticleVOPage" resultMap="ArticleVOResultMap">
        SELECT DISTINCT
            a.id,
            a.title,
            a.slug,
            a.summary,
            c.name AS category_name,
            a.thumbnail,
            a.is_top,
            a.view_count,
            a.like_count,
            a.published_time,
            a.update_time
        FROM bg_article a
        LEFT JOIN bg_category c ON a.category_id = c.id
        <if test="tagId != null">
            INNER JOIN bg_article_tag at ON a.id = at.article_id
        </if>
        <where>
            <if test="categoryId != null">
                AND a.category_id = #{categoryId}
            </if>
            <if test="tagId != null">
                AND at.tag_id = #{tagId}
            </if>
            <if test="status != null">
                AND a.status = #{status}
            </if>
            AND a.deleted = 0
        </where>
        ORDER BY
            a.is_top DESC,
            a.published_time DESC
    </select>

    <!-- ArticleDetailVO -->
    <resultMap id="ArticleDetailVOResultMap" type="com.birdy.domain.vo.ArticleDetailVO">
        <id property="id" column="id" />
        <result property="title" column="title" />
        <result property="slug" column="slug" />
        <result property="summary" column="summary" />
        <result property="content" column="content" />
        <result property="categoryId" column="category_id" />
        <result property="categoryName" column="category_name" />
        <result property="thumbnail" column="thumbnail" />
        <result property="viewCount" column="view_count" />
        <result property="likeCount" column="like_count" />
        <result property="commentCount" column="comment_count" />
        <result property="isComment" column="is_comment" />
        <result property="publishedTime" column="published_time" />
        <result property="updateTime" column="update_time" />
    </resultMap>

    <!-- RelatedArticleVO -->
    <resultMap id="RelatedArticleVOResultMap" type="com.birdy.domain.vo.RelatedArticleVO">
        <id property="id" column="id" />
        <result property="title" column="title" />
        <result property="slug" column="slug" />
        <result property="categoryName" column="category_name" />
        <result property="thumbnail" column="thumbnail" />
    </resultMap>

    <!-- AdjacentArticleVO -->
    <resultMap id="AdjacentArticleVOResultMap" type="com.birdy.domain.vo.AdjacentArticleVO">
        <id property="id" column="id" />
        <result property="title" column="title" />
        <result property="slug" column="slug" />
        <result property="thumbnail" column="thumbnail" />
    </resultMap>

    <!-- 根据ID查询文章详情 -->
    <select id="selectArticleDetailById" resultMap="ArticleDetailVOResultMap">
        SELECT 
            a.id,
            a.title,
            a.slug,
            a.summary,
            a.content,
            a.category_id,
            c.name AS category_name,
            a.thumbnail,
            a.view_count,
            a.like_count,
            a.comment_count,
            a.is_comment,
            a.published_time,
            a.update_time
        FROM bg_article a
        LEFT JOIN bg_category c ON a.category_id = c.id
        WHERE a.id = #{id}
          AND a.status = 0
          AND a.deleted = 0
    </select>

    <!-- 根据 slug 查询文章详情 -->
    <select id="selectArticleDetailBySlug" resultMap="ArticleDetailVOResultMap">
        SELECT 
            a.id,
            a.title,
            a.slug,
            a.summary,
            a.content,
            a.category_id,
            c.name AS category_name,
            a.thumbnail,
            a.view_count,
            a.like_count,
            a.comment_count,
            a.is_comment,
            a.published_time,
            a.update_time
        FROM bg_article a
        LEFT JOIN bg_category c ON a.category_id = c.id
        WHERE a.slug = #{slug}
          AND a.status = 0
          AND a.deleted = 0
    </select>

    <!-- 增加文章浏览量 -->
    <update id="incrementViewCount">
        UPDATE bg_article
        SET view_count = view_count + 1,
            update_time = NOW()
        WHERE id = #{id}
          AND deleted = 0
    </update>

    <!-- 查询相关文章（基于分类） -->
    <select id="selectRelatedArticles" resultMap="RelatedArticleVOResultMap">
        SELECT
            a.id,
            a.title,
            a.slug,
            c.name AS category_name,
            a.thumbnail
        FROM bg_article a
        LEFT JOIN bg_category c ON a.category_id = c.id
        WHERE a.category_id = #{categoryId}
          AND a.id != #{excludeArticleId}
          AND a.status = 0
          AND a.deleted = 0
        ORDER BY a.view_count DESC, a.published_time DESC
        LIMIT #{limit}
    </select>

    <!-- 查询上一篇文章（按发布时间） -->
    <select id="selectPreviousArticle" resultMap="AdjacentArticleVOResultMap">
        SELECT
            a.id,
            a.title,
            a.slug,
            a.thumbnail
        FROM bg_article a
        WHERE a.published_time &lt; #{publishedTime}
          AND a.status = 0
          AND a.deleted = 0
        ORDER BY a.published_time DESC
        LIMIT 1
    </select>

    <!-- 查询下一篇文章（按发布时间） -->
    <select id="selectNextArticle" resultMap="AdjacentArticleVOResultMap">
        SELECT
            a.id,
            a.title,
            a.slug,
            a.thumbnail
        FROM bg_article a
        WHERE a.published_time &gt; #{publishedTime}
          AND a.status = 0
          AND a.deleted = 0
        ORDER BY a.published_time ASC
        LIMIT 1
    </select>

    <!-- 增加文章点赞数 -->
    <update id="incrementLikeCount">
        UPDATE bg_article
        SET like_count = like_count + 1,
            update_time = NOW()
        WHERE id = #{id}
          AND deleted = 0
    </update>

    <!-- 减少文章点赞数 -->
    <update id="decrementLikeCount">
        UPDATE bg_article
        SET like_count = CASE
            WHEN like_count &gt; 0 THEN like_count - 1
            ELSE 0
        END,
        update_time = NOW()
        WHERE id = #{id}
          AND deleted = 0
    </update>

    <!-- 调用存储过程发布文章 -->
    <select id="publishArticleByProcedure" statementType="CALLABLE">
        {CALL sp_publish_article(#{articleId}, #{publishTime})}
    </select>

</mapper>
